(window.webpackJsonp=window.webpackJsonp||[]).push([[67],{567:function(s,t,a){"use strict";a.r(t);var e=a(4),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[s._v("#")]),s._v(" 介绍")]),s._v(" "),a("p",[s._v("幂等性操作，即任意多次执行所产生的影响均与一次执行的影响相同")]),s._v(" "),a("p",[s._v("影响范围：")]),s._v(" "),a("ul",[a("li",[s._v("写入的请求，比如提交表单、第三方接口调用、消息消费")]),s._v(" "),a("li",[s._v("数据库的"),a("code",[s._v("Insert")]),s._v("操作")]),s._v(" "),a("li",[s._v("数据库的"),a("code",[s._v("Update")]),s._v("操作，仅限累加的操作。（重复更新一个值不影响）")]),s._v(" "),a("li",[s._v("数据库的"),a("code",[s._v("Delete")]),s._v("操作，仅限删除后又新增了相同记录的情况。（很少情况，毕竟新记录主键不同）")])]),s._v(" "),a("h2",{attrs:{id:"解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[s._v("#")]),s._v(" 解决方案")]),s._v(" "),a("p",[s._v("根据实际业务情况选择最合适的，没有通用方式")]),s._v(" "),a("h3",{attrs:{id:"token机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#token机制"}},[s._v("#")]),s._v(" token机制")]),s._v(" "),a("p",[s._v("防止重复提交，比如页面表单")]),s._v(" "),a("ul",[a("li",[s._v("先获取服务器当前表单对应的随机值token")]),s._v(" "),a("li",[s._v("在提交请求时带上随机值token，后端验证，处理数据。")])]),s._v(" "),a("p",[s._v("条件：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("token保证全局唯一，可以是分布式ID或UUID")])]),s._v(" "),a("li",[a("p",[s._v("可结合Redis使用，token存Redis")])]),s._v(" "),a("li",[a("p",[s._v("需要考虑并发锁问题，采用Redis分布式锁")])])]),s._v(" "),a("p",[s._v("即服务存Redis，发送出去又请求回来，验证唯一")]),s._v(" "),a("h3",{attrs:{id:"下游唯一序列号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下游唯一序列号"}},[s._v("#")]),s._v(" 下游唯一序列号")]),s._v(" "),a("p",[s._v("使用微服务间接口调用。")]),s._v(" "),a("p",[s._v("下游根据序列号和唯一业务号做Key存储Redis，并将唯一序列号和业务号一起去调用上游，上游根据Key去Redis取做判断。")]),s._v(" "),a("p",[s._v("即下游存，上游取，验证唯一")]),s._v(" "),a("h3",{attrs:{id:"数据库表唯一键"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库表唯一键"}},[s._v("#")]),s._v(" 数据库表唯一键")]),s._v(" "),a("p",[s._v("表设置一个唯一字段，一般不用自增主键，可用分布式ID插入，出现重复数据库会报异常")]),s._v(" "),a("h3",{attrs:{id:"数据库表乐观锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库表乐观锁"}},[s._v("#")]),s._v(" 数据库表乐观锁")]),s._v(" "),a("p",[s._v("乐观锁思路，即表设置一个"),a("strong",[s._v("版本号")]),s._v("字段，每次SQL操作都必须加上"),a("strong",[s._v("以版本号为条件执行")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" sys_user "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" age"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("age"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" version"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("version"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" version"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("xx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"数据库临时表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库临时表"}},[s._v("#")]),s._v(" 数据库临时表")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" sys_user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 多一条临时表查询")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'admin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" dual\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exists")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" sys_user "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'admin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("缺点：不必要的子查询、简单的SQL反而需要自定义重写且不优雅！")]),s._v(" "),a("h3",{attrs:{id:"细粒度分布式锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#细粒度分布式锁"}},[s._v("#")]),s._v(" 细粒度分布式锁")]),s._v(" "),a("p",[s._v("写一个统一父类。定义Insert、update封装方法，先基于分布式锁查询验证，再执行Insert、update方法")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("saveOrUpdateIdempotency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" entity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DistributedLock")]),s._v(" lock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" lockKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Wrapper")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" countWrapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//判断entity是否为空")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//mybatis-plus的TableInfoHelper.getTableInfo方法，验证表信息、缓存")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//分布式锁")]),s._v("\n    \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//先查询是否存在")]),s._v("\n    \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//再Insert、update方法")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//释放锁")]),s._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//或者直接Insert、update方法")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("缺点：多一次select操作，性能影响不多，仅再重复操作时阻塞")])])}),[],!1,null,null,null);t.default=n.exports}}]);